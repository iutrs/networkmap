<!doctype html>
<html>
<head>
    <title>networkmap</title>

    <!-- Adapting the view for mobile devices -->
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width" />

    <script type="text/javascript" src="./js/vis.js"></script>
    <script type="text/javascript" src="./js/jquery-1.11.2.min.js"></script>

    <link type="text/css" href="./js/vis.css" rel="stylesheet"/>
    
    <style type="text/css">
        html, body {
            width: 95%;
            height: 95%;
        }
        #networkmap {
            width: 100%;
            height: 100%;
            border: 1px solid lightgray;
        }
    </style>

    <script type="text/javascript">
        var jsonFile = "devices.json"
        var devices = null;
        
        // The JSON must be fully loaded before onload() happens for calling draw() on 'devices'  
        $.ajaxSetup({
            async: false
        });

        $.getJSON(jsonFile, function(json) {
            devices = json;
        });

        var network = null;

        // Arrays used by vis to generate the network graph
        var visNodes = []
        var visEdges = []

        // Arrays used to keep information in memory
        var myNodes = []
        var myEdges = []

        function draw() {

            createNodes();
            createEdges();

            var container = document.getElementById('networkmap');

            var data = {
                nodes: visNodes,
                edges: visEdges
            };

            var options = {
                stabilize: true,
                selectable: true,
                smoothCurves: false,
                physics: {
                    barnesHut: {
                        enabled: true,
                        gravitationalConstant: -2500,
                        centralGravity: 0.5,
                        springLength: 150,
                        springConstant: 0.1,
                        damping: 1
                    },
                    repulsion: {
                        centralGravity: 0.5,
                        springLength: 150,
                        springConstant: 0.1,
                        nodeDistance: 75,
                        damping: 1
                    }
                }
            };

            network = new vis.Network(container, data, options);
            network.freezeSimulation(true)
        }

        function createNodes() {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]

                color = '#2B7CE9';
                if (device.interfaces.length == 0) {
                    color = '#C5000B';
                }

                visNodes.push(
                {
                    'id': device.mac_address,
                    'label': device.system_name + "\n" + device.ip_address,
                    'shape': 'square',
                    'color': color,
                    'title': buildNodeDescription(device),
                    'value': device.interfaces.length + 1,
                    'mass': device.interfaces.length + 1
                });

                myNodes.push(device.mac_address)
            }
        }

        function createEdges() {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]

                for (var i = 0; i < device.interfaces.length; i++) {
                    int = device.interfaces[i]
                    link = [device.mac_address, int.remote_mac_address]

                    if (myNodes.indexOf(int.remote_mac_address) > -1 && !exists(link)) {
                        visEdges.push(
                            {
                                'from': link[0],
                                'to': link[1],
                                'style': 'line',
                                'color': undefined,
                                'width': undefined,
                                'length': undefined,
                                'value': undefined,
                                'title': '',
                                'label': int.remote_port + " -> " + int.local_port,
                                'labelAlignment' : 'line-center'
                            });

                        myEdges.push(link)
                    }
                }
            }

        }

        // Verifies whether a link already exist or not
        function exists(link) {
            for (var e = 0; e < myEdges.length; e++) {
                from = myEdges[e][0]
                to = myEdges[e][1]
                if ((from == link[0] && to == link[1]) ||
                    (from == link[1] && to == link[0])) {
                    return true
                }
            }
        }
        
        // Builds node description when hovering
        function buildNodeDescription(device) {
            ip = "?"
            ip_type = "?"
            if (device.ip_address) {
                ip = device.ip_address
            }
            if (device.ip_address_type) {
                ip_type = device.ip_address_type.toUpperCase()
            }
            
            return (
                "<b>" + device.system_name + "</b></br>" +
                device.system_description + "</br>" +
                "<b>" + ip_type + ":</b> " + ip + "</br>" +
                "<b>MAC:</b> " + device.mac_address + "</br>" +
                "<b>Capabilities:</b> " + device.enabled_capabilities + "</br>" +
                "<b>Connected ports:</b></br>" + buildDeviceConnectedPorts(device)
            )
        }
        
        // Builds device's connected ports list
        function buildDeviceConnectedPorts(device) {

            var connectedPorts = "";
            var unknownCount = 0

            for (var i = 0; i < device.interfaces.length; i++) {
                var int = device.interfaces[i];
                
                if (int.remote_system_name == "") {
                    unknownCount++;
                }
                else {
                    var line = int.local_port + " --> " + 
                        int.remote_port + "\t(" + int.remote_system_name + ")</br>";
                        
                    connectedPorts += line;
                }
            }

            if (unknownCount > 0) {
                connectedPorts += "<b>Other connections:</b> " + unknownCount
            }

            return connectedPorts != "" ? connectedPorts : ""; 
        }
    </script>

</head>

<body onload="draw();" onresize="network.redraw();">
    <div id="networkmap"></div>
</body>

</html>
