<html>

<head>
	<title>networkmap</title>

	<!-- Adapting the view for mobile devices --> 
	<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width" />

	<script type="text/javascript" src="./js/network-min.js"></script>
	<script type="text/javascript" src="./js/jquery-1.11.2.min.js"></script>

	<script type="text/javascript">
		var uniqueID = 0;
		
		var jsonFile = "devices.json"
		var devices = null;
		
		$.getJSON(jsonFile, function(json) {
			devices = json;
		});
		
		var nodesTable = null;
		var linksTable = null;
		var network = null;
		
		// Draws the network map from the devices
		function draw() {
			
			nodesTable = [];
			linksTable = [];
			
			// Temporary alert
			if (devices == null) {
				alert("Could not find '" + jsonFile + "'.")
			}
			
			buildGraph(devices, nodesTable, linksTable, undefined, undefined)
			
			network = new links.Network(document.getElementById('networkmap'));
			
			links.events.addListener(network, 'select', onselect);
			
			var options = {
				width:  '100%',
				height: '100%',
				stabilize: true,
				selectable: true
			};
			
			network.draw(nodesTable, linksTable, options);
		}
		
		// Iterates through the devices to add the nodes and the links
		function buildGraph(device, nodesTable, linksTable, ID, parentID) {
			ID = getNewID();
			
			var x = undefined;
			var y = undefined
			
			if (ID == 1) {
				x = $(document).width()/2;
				y = $(document).height()/2;
			}
				
			nodesTable.push(
				{
					'id': ID,
					'text': device.system_name + "\n" + device.ip_address,
					'style': 'rect',
					'group': 1,
					'title': buildNodeDescription(device),
					'value': device.children.length,
					'x': x,
					'y': y
				});
			
			if (parentID > 0) {
				var line = device.remote_port + " --> " + device.local_port;
				linksTable.push(
				{
					'from': parentID,
					'to': ID,
					'style': 'arrow-end',
					'color': undefined,
					'width': 2,
					'length': (parentID == 1) ? 500 : 250,
					'value': undefined,
					'title': undefined,
					'text': line
					
				});
			}
			
			for (var i = 0; i < device.children.length; i++) {
				buildGraph(device.children[i], nodesTable, linksTable, ID+i+1, ID);
			}
		}
		
		// Builds node description when hovering
		function buildNodeDescription(device) {
			return (
				"<b>" + device.system_name + "</b></br>" +
				device.system_description + "</br>" +
				"<b>" + device.ip_address_type.toUpperCase() + ":</b> " +
				device.ip_address + "</br>" +
				"<b>MAC:</b> " + device.mac_address + "</br>" +
				"<b>Capabilities:</b> " + device.enabled_capabilities + "</br>" +
				"<b>Connected ports:</b></br>" + buildDeviceConnectedPorts(device)
			)
		}
		
		// Builds device connected ports list
		function buildDeviceConnectedPorts(device) {
			
			var connectedPorts = "";
			
			if (device.local_port != null && device.remote_port != null) {
				var line = device.local_port + " --> " + device.remote_port + "</br>";
					
				connectedPorts += line;
			}
			
			for (var i = 0; i < device.children.length; i++) {
				var children = device.children[i];
				
				var line = children.remote_port + " --> " + 
					children.local_port + " (" + children.ip_address + ")</br>";
					
				connectedPorts += line;
			}
			
			return connectedPorts; 
		}
		
		// Handles the selection of the nodes
		function onselect() {
			var selection = network.getSelection();
			
			var info = 'selected row(s): '
			for (var i = 0; i < selection.length; i++) {
				info += selection[i].row + ' ';
			}
			
			console.log('Selection: ' + JSON.stringify(selection));
		}
		
		// Generates a unique ID for the nodes
		function getNewID() {
			return uniqueID+=1;
		}
		
	</script>
	
</head>

<body onload="draw();" onresize="network.redraw();">
	<div id="networkmap"></div>
</body>

</html>
