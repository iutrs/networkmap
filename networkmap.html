<!doctype html>
<html>
<head>
    <title>networkmap</title>

    <!-- Adapting the view for mobile devices -->
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width" />

    <script type="text/javascript" src="./js/vis.js"></script>
    <script type="text/javascript" src="./js/jquery-1.11.2.min.js"></script>

  <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
    }

    #networkmap {
      width: 100%;
      height: 100%;
    }
  </style>

    <script type="text/javascript">
        var jsonFile = "devices.json"
        var devices = null;
        
        // The JSON must be fully loaded before onload() happens for calling draw() on 'devices'  
        $.ajaxSetup({
            async: false
        });

        $.getJSON(jsonFile, function(json) {
            devices = json;
        });

        // Arrays used by vis to generate the network graph
        var visNodes = []
        var visEdges = []

        // Arrays used to keep information in memory
        var myNodes = []
        var myEdges = []

        function draw() {

            createNodes();
            createEdges();

            var container = document.getElementById('networkmap');
            var data = {nodes: visNodes, edges: visEdges};
            var options = {
                stabilize: true,
                selectable: true,
                //configurePhysics:true,
                physics: {
                    repulsion: {
                        nodeDistance: 75,
                        springLength: 150,
                        damping: 0.3
                    }
                },
                smoothCurves: false
            };

            var network = new vis.Network(container, data, options);
        }

        function createNodes() {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]

                color = '#2B7CE9';
                if (device.interfaces.length == 0) {
                    color = '#C5000B';
                }

                visNodes.push(
                {
                    'id': device.mac_address,
                    'label': device.system_name + "\n" + device.ip_address,
                    'shape': 'square',
                    'color': color,
                    'title': "",
                    'mass': device.interfaces.length + 1
                });

                myNodes.push(device.mac_address)
            }
        }

        function createEdges() {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]

                for (var i = 0; i < device.interfaces.length; i++) {
                    int = device.interfaces[i]
                    link = [device.mac_address, int.remote_mac_address]

                    if (myNodes.indexOf(int.remote_mac_address) > -1 && !exists(link)) {
                        visEdges.push(
                            {
                                'from': link[0],
                                'to': link[1],
                                'style': 'line',
                                'color': undefined,
                                'width': 2,
                                'length' : 500,
                                'value': undefined,
                                'title': undefined,
                                'textTo': int.local_port,
                                'textFrom': int.remote_port
                            
                            });

                        myEdges.push(link)
                    }
                }
            }

        }

        function exists(link) {
            for (var e = 0; e < myEdges.length; e++) {
                from = myEdges[e][0]
                to = myEdges[e][1]
                if ((from == link[0] && to == link[1]) ||
                    (from == link[1] && to == link[0])) {
                    return true
                }
            }
        }
    </script>

</head>

<body onload="draw();" onresize="network.redraw();">
    <div id="networkmap"></div>
</body>

</html>
