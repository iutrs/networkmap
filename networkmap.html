<html>

<head>
    <title>networkmap</title>

    <!-- Adapting the view for mobile devices --> 
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width" />

    <script type="text/javascript" src="./js/network-modified-min.js"></script>
    <script type="text/javascript" src="./js/jquery-1.11.2.min.js"></script>

    <script type="text/javascript">

        var jsonFile = "devices.json"
        var devices = null;
        
        $.getJSON(jsonFile, function(json) {
            devices = json;
        });
        
        var nodesTable = null;
        var linksTable = null;
        var network = null;
        
        var objects = []
        var connections = []

        // Draws the network map from the devices
        function draw() {
            
            nodesTable = [];
            linksTable = [];
            
            createNodes(nodesTable, objects)
            createLinks(linksTable, connections)
            
            network = new links.Network(document.getElementById('networkmap'));
            
            links.events.addListener(network, 'select', onselect);
            
            var options = {
                width:  '100%',
                height: '100%',
                stabilize: true,
                selectable: true
            };
            
            network.draw(nodesTable, linksTable, options);
        }
        
        function createNodes(nodesTable, objects) {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]
                nodesTable.push(
                {
                    'id': device.mac_address,
                    'text': device.system_name + "\n" + device.ip_address,
                    'style': 'rect',
                    'group': 1,
                    'title': "",
                    'value': device.interfaces.length,
                });
                objects.push(device.mac_address)
            }
        }
        
        function createLinks(linksTable, connections) {
            for (var d = 0; d < devices.length; d++) {
                device = devices[d]

                for (var i = 0; i < device.interfaces.length; i++) {
                    int = device.interfaces[i]

                    if (objects.indexOf(int.remote_mac_address) > -1) { 
                        connection = [device.mac_address, int.remote_mac_address]

                        if (!exists(connection)) {
                            linksTable.push(
                                {
                                    'from': connection[0],
                                    'to': connection[1],
                                    'style': 'line',
                                    'color': undefined,
                                    'width': 2,
                                    'length' : 500,
                                    'value': undefined,
                                    'title': undefined,
                                    'textTo': int.local_port,
                                    'textFrom': int.remote_port
                                
                                });
                            connections.push(connection)
                        }
                    }
                }
            }
        }
        
        function exists(connection) {
            for (var i = 0; i < connections.length; i++) {
                from = connections[i][0]
                to = connections[i][1]
                console.log(from, to)
                console.log(connection)
                if ((from == connection[0] && to == connection[1]) ||
                    (from == connection[1] && to == connection[0])) {
                    return true
                }
            }
        }

        // Builds node description when hovering
        function buildNodeDescription(device) {
            return (
                "<b>" + device.system_name + "</b></br>" +
                device.system_description + "</br>" +
                "<b>" + device.ip_address_type.toUpperCase() + ":</b> " +
                device.ip_address + "</br>" +
                "<b>MAC:</b> " + device.mac_address + "</br>" +
                "<b>Capabilities:</b> " + device.enabled_capabilities + "</br>" +
                "<b>Connected ports:</b></br>" + buildDeviceConnectedPorts(device)
            )
        }
        
        // Builds device's connected ports list
        function buildDeviceConnectedPorts(device) {
            
            var connectedPorts = "";
            
            if (device.local_port != null && device.remote_port != null) {
                var line = device.local_port + " --> " + device.remote_port + "</br>";
                    
                connectedPorts += line;
            }
            
            for (var i = 0; i < device.children.length; i++) {
                var children = device.children[i];
                
                var line = children.remote_port + " --> " + 
                    children.local_port + " (" + children.ip_address + ")</br>";
                    
                connectedPorts += line;
            }
            
            return connectedPorts; 
        }
        
        // Handles the selection of the nodes
        function onselect() {
            var selection = network.getSelection();
            
            var info = 'selected row(s): '
            for (var i = 0; i < selection.length; i++) {
                info += selection[i].row + ' ';
            }
            
            console.log('Selection: ' + JSON.stringify(selection));
        }
        
    </script>
    
</head>

<body onload="draw();" onresize="network.redraw();">
    <div id="networkmap"></div>
</body>

</html>
